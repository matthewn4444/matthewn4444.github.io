<!DOCTYPE html>
<html>
  <head>
  <link href='libjass.css' rel='stylesheet'/>
  <link href='style.css' rel='stylesheet'/>
  <link href='loading.css' rel='stylesheet'/>
<style type="text/css">
  @import url(https://fonts.googleapis.com/css?family=Roboto);

  body {
    font-family: "Roboto", serif;
    color: #444;
    border: 0px;
    margin: 0px;
    overflow: hidden !important;
    background: white;
  }
  .center {
    position:fixed;
    left:50%;
    top:50%;
    -webkit-transform: translate(-50%, -50%);
    z-index: 1000;
  }
  video {
    height: 100%;
    width: 100%;
  }
  #video-area {
    position: fixed;
    left:0;
    top:0;
    width: 100%;
    height: 100%;
    margin: auto auto;
    overflow: hidden !important;
    background:black;
    display: none;
  }
  .intro {
    font-size: 40px;
    margin: 0 auto;
    text-align: center;
    margin-top: 15%;
    width: 100%;
    height: 100%;
  }
  .logo {
    width: 300px;
    height: 300px;
  }

  /* Buffer Loading Items */
  #buffer {
    display:none;
  }
  body.preload #buffer .buffering, body:not(.preload) #buffer .preload {
    display: none;
  }
  body.preload #buffer .preload, .#buffer .buffering {
    display: block !important;
  }
  #progress {
    font-weight: bold;
    color:white;
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
  }
  /* Error Message */
  #error {
    position:fixed;
    background:#999;
    color:white;
    top:-100px;
    left:50%;
    padding: 20px;
    font-size:25px;
    transform: translateX(-50%);
    box-shadow: 7px 7px 0 #DDD;
    width:650px;
    text-align:center;
  }

</style>
<script type="text/javascript"
    src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js">
</script>
<script type="text/javascript" src="jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="libjass.js"></script>
<script type="text/javascript" src="ssaplayer.js"></script>
<title>Cast Simple Receiver</title>
</head>
  <body>
    <span id='font-preloader' style='position:fixed;visiblity:hidden;'></span>
    <section class='intro'>
        <h1>Melon Pan</h1>
        <img class='logo' src="icon.png"/>
    </section>
     <section id='video-area'>
        <video id='vid'></video>
        <div id='buffer'>
            <img class='center preload' src='preloading.gif'/>
            <div class="sk-circle center buffering">
              <div class="sk-circle1 sk-child"></div>
              <div class="sk-circle2 sk-child"></div>
              <div class="sk-circle3 sk-child"></div>
              <div class="sk-circle4 sk-child"></div>
              <div class="sk-circle5 sk-child"></div>
              <div class="sk-circle6 sk-child"></div>
              <div class="sk-circle7 sk-child"></div>
              <div class="sk-circle8 sk-child"></div>
              <div class="sk-circle9 sk-child"></div>
              <div class="sk-circle10 sk-child"></div>
              <div class="sk-circle11 sk-child"></div>
              <div class="sk-circle12 sk-child"></div>
            </div>
            <span class='center' id='progress'>40%</span>
        </div>
    </section>
    <div id='error'></div>

<script type="text/javascript">
var BUFFER_END_TIMEOUT = 50;

function showBufferAnimation() {
    $("#progress").text("0%");
    $("#buffer").fadeIn();
    window.lastBufferPercent = 0;
    window.isBuffering = true;
}

function hideBufferAnimation() {
    window.isBuffering = false;
    if ($("#buffer").is(":visible")) {
        $("#buffer").fadeOut(200, function() {
            $(document.body).removeClass("preload");
        });
    }
    if (window.bufferTimer) {
        clearInterval(window.bufferTimer);
        window.bufferTimer = null;
    }
}

window.onload = function() {
//cast.receiver.logger.setLevelValue(cast.receiver.LoggerLevel.DEBUG);

    // Start the system
    console.log('Application is ready, starting system');
    window.mediaElement = document.getElementById('vid');
    window.mediaManager = new cast.receiver.MediaManager(window.mediaElement);
    window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();

    $(window.mediaElement).on("loadstart", function() {
        hideBufferAnimation();
        if (!$("#video-area").is(":visible")) {
            $("#video-area").fadeIn();
        }
    });

    $(window.mediaElement).on("abort ended error", function(e) {
        console.log(e);
        $("#video-area").fadeOut(200);
    });

    $(window.mediaElement).on("error", function(e) {
        if (e.target.error) {
            switch (e.target.error.code) {
                case e.target.error.MEDIA_ERR_DECODE:
                case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                case e.target.error.MEDIA_ERR_ABORTED:
                case e.target.error.MEDIA_ERR_NETWORK:
                    break;
                default:
                    window.close();
                    break;
            }
        }
    });

    // Handle Subtitles
    window.messageBus = window.castReceiverManager.getCastMessageBus('urn:x-cast:com.melonpan.messages');
    window.messageBus.onMessage = function(event) {
        try {
            var data = JSON.parse(event.data);
            if (data.action == "new.subtitle.player") {
                // Remove the old player and add a new one
                if (window.subtitlePlayer) {
                    window.subtitlePlayer.remove();
                }
                window.subtitlePlayer = new SSAPlayer({ video: window.mediaElement });
            } else if (data.action == "set.subtitles.header") {
                // This is new ssa subtitle track
                window.subtitlePlayer.newTrack("track_" + data.number, data.header);
            } else if (data.action == "add.subtitles") {
                // Add subtitles streamed from sender app
                for (var i = 0; i < data.tracks.length; i++) {
                    window.subtitlePlayer.addSubtitleEvent("track_" + data.number, data.tracks[i]);
                }
            } else if (data.action == "select.subtitles.track") {
                if (data.hasOwnProperty("number")) {
                    window.subtitlePlayer.selectTrack("track_" + data.number);
                } else {
                    // Hide subtitles
                    window.subtitlePlayer.selectTrack("");
                }
            } else if (data.action == "preload.font") {
                // Preload each font; add the font into each element to start preloading
                for (var i = 0; i < data.fonts.length; i++) {
                    var fontData = data.fonts[i];
                    $("head").append($("<style>").text("@font-face{font-family:'" + fontData.name + "';src:url('" + fontData.url + "') format('truetype');}"));
                    var el = document.createElement("span");
                    el.style.fontFamily = fontData.name;
                    document.getElementById("font-preloader").appendChild(el);
                }
            } else if (data.action == "player.error") {
                // Ends the video and shows errors to the user
                $("#error").text(data.message).animate({top: "40px"}, 400);
                $("#video-area").fadeOut(200);
                setTimeout(function(){
                    $("#error").animate({top: "-100px"}, 400);
                }, 8000);
            } else if (data.action == "player.hide") {
                $("#video-area").fadeOut(200);
            }

            // Streaming related events
            else if (data.action == "preload.stream") {
                // Preload the video backdrop for torrent
                $("body").addClass("preload");
                $("#video-area").fadeIn(500, showBufferAnimation);
            } else if (data.action == "buffer.start" && !$("#buffer").is(":visible")) {
                showBufferAnimation();

                // Run an interval to see when the video has finished buffering and starts to play
                window.lastPlayTime = window.mediaElement.currentTime;
                if (window.bufferTimer) {
                    clearInterval(window.bufferTimer);
                }
                window.bufferChangeCount = 0;
                window.bufferTimer = setInterval(function() {
                    if (window.mediaElement.currentTime > (1 / BUFFER_END_TIMEOUT + window.lastPlayTime) && !window.mediaElement.paused) {
                        window.bufferChangeCount++;
                        // If user seeks multiple times, then animation would be removed, we avoid with the count
                        if (window.bufferChangeCount > 2) {
                            hideBufferAnimation();
                        }
                    } else {
                        window.bufferChangeCount = 0;
                    }
                    window.lastPlayTime = window.mediaElement.currentTime;
                }, BUFFER_END_TIMEOUT);
            } else if (data.action == "buffer.precentage") {
                // Never show 100% because it could be waiting a little longer
                // Also never show a lower number than what is already being shown
                var percent = parseInt(data.percentage, 10);
                if (percent > window.lastBufferPercent) {
                    window.lastBufferPercent = Math.min(percent, 99);
                    $("#progress").text(window.lastBufferPercent + "%");
                }
            }
        } catch(e) {
            console.error(e);
        }
    }

    castReceiverManager.start({maxInactivity: 600});

    // Disconnect if no senders
    window.castReceiverManager.onSenderDisconnected = function(event) {
    if(window.castReceiverManager.getSenders().length == 0 &&
        event.reason == cast.receiver.system.DisconnectReason.REQUESTED_BY_SENDER) {
            window.close();
        }
    }
};
</script>
  </body>
</html>

